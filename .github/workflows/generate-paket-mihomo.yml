name: Generate PKG Info

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dummy
        uses: actions/checkout@v4

      - name: Clone and archive Mihomo
        run: |
          git clone https://github.com/MetaCubeX/mihomo.git
          cd mihomo
          # Ambil tag terbaru
          TAG=$(git tag --sort=-creatordate | head -n1)
          git checkout $TAG
          # Commit dan tanggal
          COMMIT=$(git rev-parse HEAD)
          DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')
          VERSION=${TAG}-${COMMIT:0:8}
          ARCHIVE_NAME=mihomo-${DATE}~${COMMIT:0:8}
          # Buat tarball
          git archive --format=tar --prefix="${ARCHIVE_NAME}/" HEAD | zstd -19 -o "../${ARCHIVE_NAME}.tar.zst"
          # Hitung hash
          HASH=$(sha256sum "../${ARCHIVE_NAME}.tar.zst" | cut -d ' ' -f1)
          # Simpan info ke file di direktori kerja utama
          cd ..
          {
            echo "PKG_SOURCE_DATE=$DATE"
            echo "PKG_SOURCE_VERSION=$COMMIT"
            echo "PKG_BUILD_VERSION=$VERSION"
            echo "PKG_MIRROR_HASH=$HASH"
          } > pkg_info.txt
      - name: Print Info
        run: cat pkg_info.txt

      - name: Upload Info
        uses: actions/upload-artifact@v4
        with:
          name: pkg-info
          path: pkg_info.txt

      - name: Upload Archive
        uses: actions/upload-artifact@v4
        with:
          name: mihomo-archive
          path: mihomo-*.tar.zst
