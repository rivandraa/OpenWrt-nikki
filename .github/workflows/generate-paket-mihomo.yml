name: Generate PKG Info

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dummy
        uses: actions/checkout@v4

        - name: Clone, archive, and update Makefile
        run: |
          git clone https://github.com/MetaCubeX/mihomo.git
          cd mihomo
          TAG=$(git tag --sort=-creatordate | head -n1)
          git checkout $TAG
          COMMIT=$(git rev-parse HEAD)
          DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')
          VERSION=${TAG}-${COMMIT:0:8}
          ARCHIVE_NAME=mihomo-${DATE}~${COMMIT:0:8}
          git archive --format=tar --prefix="${ARCHIVE_NAME}/" HEAD | zstd -19 -o "../${ARCHIVE_NAME}.tar.zst"
          HASH=$(sha256sum "../${ARCHIVE_NAME}.tar.zst" | cut -d ' ' -f1)
          cd ..

          # Langsung edit Makefile
          MAKEFILE=package/nikki/Makefile  # Ganti dengan path sebenarnya

          sed -i "s/^PKG_SOURCE_DATE:=.*/PKG_SOURCE_DATE:=${DATE}/" "$MAKEFILE"
          sed -i "s/^PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=${COMMIT}/" "$MAKEFILE"
          sed -i "s/^PKG_MIRROR_HASH:=.*/PKG_MIRROR_HASH:=${HASH}/" "$MAKEFILE"
          sed -i "s/^PKG_BUILD_VERSION:=.*/PKG_BUILD_VERSION:=${VERSION}/" "$MAKEFILE"
